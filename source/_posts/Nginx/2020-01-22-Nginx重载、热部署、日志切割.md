---
title: Nginx重载、热部署、日志切割
date: 2020-01-22 15:33:06
categories: Nginx
tags: 重载 热部署 日志切割
---

### 配置文件重载

```shell
sudo nginx -s reload
```

### nginx升级热部署

1. 备份原二进制文件

```shell
sudo cp nginx nginx.old
```

2. 把新编译生成的二进制文件复制到nginx安装目录中的sbin目录下

```shell
sudo cp -r ./nginx  /usr/local/nginx/sbin/ -f
```

3. 查看nginx进程号，当前master进程号`1334`

```shell
ps -ef | grep nginx
```
<!-- more -->

4. 向master进程发送USR2信号，通知nginx进行热部署

> 给nginx发送USR2信号后，nginx会将logs/nginx.pid文件重命名为nginx.pid.oldbin，然后用新的可执行文件启动一个新的nginx主进程和对应的工作进程，并新建一个新的nginx.pid保存新的主进程号。

```shell
sudo kill -USR2 1334
```

5. 优雅关闭所有的老Worker进程，老的Master进程还会存在，可通过reload命令重新拉起worker进程，用来版本回退。

```shell
sudo kill -WINCH 1334
```

### nginx日志切割

1. 备份原日志

```shell
sudo mv access.log access.log.bak
```

2. 向Nginx主进程发送USR1信号。USR1信号是重新打开日志文件，等同于`nginx -s reopen`

```shell
sudo kill -USR1 $(cat /usr/local/nginx/logs/nginx.pid)
```

设置定时任务每月执行日志切割

```shell
crontab -l
0 0 1 * * root /usr/local/nginx/logs/rotate.sh
```

![nginx日志切割.png](http://picgo.anbulang.cn/picgo/nginx日志切割.png)